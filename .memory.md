# Mob Hunter v3.0 - Application Memory

**Last Updated:** 2024-12-19  
**Version:** 3.0 (Complete Rewrite)  
**Status:** Active Development

---

## üìã APPLICATION OVERVIEW

**Mob Hunter v3.0** is a complete MMORPG auto-combat bot for **Silkroad Online (Legends)**. It uses computer vision, pattern matching, and color detection to automatically detect mobs, filter out pets/players, and engage in combat.

### Core Purpose
- **Real-time mob detection** using screen capture and image processing
- **Smart filtering** to avoid pets and players
- **Automated combat** with skill rotation
- **Live overlay visualization** for monitoring
- **Comprehensive logging** with session-based logs

### Key Features
1. **No External OCR Dependencies** - Uses simple pattern matching instead of Tesseract/EasyOCR
2. **Color-Based Detection** - Detects mob classes by color patterns in nameplate
3. **Position Caching** - Remembers recently checked positions to avoid duplicates
4. **Session Logging** - Creates timestamped log directories with screenshots
5. **Live Overlay** - Real-time visualization of detections and statistics

---

## üèóÔ∏è ARCHITECTURE

### Main Components

#### 1. **Config Class** (Lines 27-87)
Centralized configuration for all bot parameters:
- **Screen Settings:** 1920x1080 resolution, nameplate region (660, 10, 600, 100)
- **Detection Boundaries:** Ignore top 120px, bottom 200px, sides 60px
- **Name Detection:** Width 25-300px, height 8-35px, aspect ratio 1.5-20
- **Blacklist:** Known pets (Gom3a, Savy), player indicators (SnowRunner, guild tags)
- **Combat Settings:** Min health 5%, max 2 targets per cycle, 0.4s cycle delay
- **Priority System:** Unique(1) > Champion(2) > Giant(3) > General(4) > Elite(5)
- **Skill Rotation:** Keys ['1', '2', '3', '4'] with 0.6s delay

#### 2. **ScreenCapture Class** (Lines 128-139)
- Uses `mss` library for fast screen capture
- Captures full screen region (1920x1080)
- Converts BGRA to BGR for OpenCV processing
- Simple, fast capture method

#### 3. **SimpleOCR Class** (Lines 145-221)
**NO Tesseract/EasyOCR - Uses Pattern Matching:**
- `extract_text_simple()`: Detects white text density (10% threshold)
- `analyze_region_advanced()`: Multi-factor analysis:
  - White pixel ratio (5-70%)
  - Edge detection (Canny)
  - Variance analysis
  - Returns score-based validation
- Returns unique identifiers instead of actual text

#### 4. **FloatingNameDetector Class** (Lines 227-299)
Detects white floating names in game world:
- **Multi-threshold approach:** Tests thresholds [200, 180, 160]
- **Morphological operations:** Connects text with horizontal kernel (3x1)
- **Contour detection:** Finds all text regions
- **Filtering:**
  - Size: Width 25-300px, Height 8-35px
  - Aspect ratio: 1.5-20
  - Position: Excludes UI regions
- **Deduplication:** Removes detections within 20px of each other
- Returns list of detections with region, center, and score

#### 5. **NameFilter Class** (Lines 305-349)
Filters out pets and players:
- `is_valid_mob_region()`: 
  - Rejects names near screen center (<150px) where player usually is
  - Simple heuristic-based filtering
- `should_skip_position()`:
  - Defines player zone (center ¬±200px x, center ¬±100-150px y)
  - Skips positions in player zone

#### 6. **PositionCache Class** (Lines 355-399)
Remembers recently checked positions:
- **Cache duration:** 2.5 seconds
- **Proximity threshold:** 35 pixels
- **Auto-cleanup:** Removes old entries automatically
- **Statistics:** Tracks hit/miss rates
- Prevents re-clicking same entities

#### 7. **NameplateReader Class** (Lines 405-529)
Reads mob info from nameplate (top-middle screen):
- `click_and_read()`: 
  - Clicks position
  - Waits 0.25s
  - Attempts to read nameplate with timeout (1.0s default)
  - Retries every 0.1s until success or timeout
- `read_nameplate()`: Extracts nameplate region (660, 10, 600, 100)
- `detect_class_by_color()`: **Color-based class detection:**
  - **Yellow pixels > 50:** Elite
  - **Red pixels > 100:** Unique
  - **Default:** General
- `detect_health()`: 
  - Uses HSV color space
  - Detects red health bar (two HSV ranges: 0-10¬∞ and 170-180¬∞)
  - Finds largest red contour
  - Calculates percentage based on bar width (assumes 300px full width)

#### 8. **CombatSystem Class** (Lines 535-564)
Handles combat execution:
- `engage()`: Executes skill rotation
- Presses keys in sequence: ['1', '2', '3', '4']
- 0.6s delay between skills
- Tracks total engagements/kills
- Logs combat actions

#### 9. **OverlayWindow Class** (Lines 570-632)
Live visualization overlay:
- **OpenCV-based** (not Tkinter)
- Runs in separate daemon thread
- Updates at 10 FPS (configurable)
- **Displays:**
  - Green rectangles around detected names
  - Red circles at detection centers
  - Statistics text overlay (cycle, detections, kills, etc.)
- Window title: "MOB HUNTER v3.0 - Detection Overlay"
- Can be disabled via `Config.SHOW_OVERLAY`

#### 10. **MobHunter Class** (Lines 638-793)
Main bot controller orchestrating all components:
- **Initialization:**
  - Sets up logging (timestamped session directory)
  - Creates all component instances
  - Initializes statistics
  - Sets up keyboard listener for CapsLock
  - Starts in paused state (`is_paused = True`)
- **Keyboard Control:**
  - `setup_keyboard_listener()`: Listens for CapsLock to toggle pause
  - CapsLock toggles between running and paused states
- **Shutdown:**
  - `shutdown()`: Gracefully stops keyboard listener and overlay
  - Signal handler for Ctrl+C
- **Main Loop (`run()`):**
  - Starts paused, waits for CapsLock
  - Runs cycles only when not paused
  - 0.4s delay between cycles
  - Checks `is_paused` flag before each cycle
  - Handles KeyboardInterrupt gracefully
  - Prints final statistics on exit
- **Cycle Logic (`run_cycle()`):**
  1. Capture screenshot
  2. Detect floating names
  3. Filter by cache and position
  4. Validate regions
  5. Click and verify via nameplate (max 2 per cycle)
  6. Select best target by priority
  7. Engage in combat if health > 5%
  8. Update overlay
  9. Save screenshot every 10 cycles (if enabled)

---

## üîÑ DETECTION PIPELINE

### Step-by-Step Flow

1. **Screen Capture**
   - Captures full screen (1920x1080) using MSS
   - Converts to BGR format

2. **Floating Name Detection**
   - Converts to grayscale
   - Applies multiple thresholds (200, 180, 160)
   - Morphological closing to connect text
   - Finds contours
   - Filters by size, aspect ratio, position
   - Deduplicates nearby detections

3. **Pre-Filtering**
   - Checks position cache (skip if recently checked)
   - Checks if in player zone (skip if near center)
   - Validates region (not near screen center)

4. **Click and Verify**
   - Clicks position (below text, +25px)
   - Waits 0.25s
   - Captures nameplate region
   - Detects class by color (yellow/red patterns)
   - Detects health by red bar width

5. **Target Selection**
   - Sorts by priority (lower number = higher priority)
   - Selects best target
   - Checks health threshold (must be > 5%)

6. **Combat**
   - Executes skill rotation: 1, 2, 3, 4
   - 0.6s delay between skills
   - Logs engagement

---

## üìä LOGGING SYSTEM

### Log Structure
- **Directory:** `logs/session_YYYYMMDD_HHMMSS/`
- **Files:**
  - `bot.log` - Main log file (UTF-8 encoding)
  - `screenshots/cycle_XXXX.png` - Screenshots (every 10 cycles)

### Log Levels
- **DEBUG:** Detailed detection info, cache hits, position checks
- **INFO:** Cycle numbers, detections found, engagements
- **ERROR:** Exceptions, fatal errors

### Log Format
```
YYYY-MM-DD HH:MM:SS | LEVEL     | Message
```

### Statistics Tracked
- Total cycles
- Total clicks
- Total engagements/kills
- Cache hit rate
- Uptime
- Average cycle time

---

## ‚öôÔ∏è CONFIGURATION DETAILS

### Screen Settings
```python
SCREEN_WIDTH = 1920
SCREEN_HEIGHT = 1080
NAMEPLATE_REGION = (660, 10, 600, 100)  # (x, y, w, h)
```

### Detection Boundaries
```python
IGNORE_TOP = 120      # Pixels from top
IGNORE_BOTTOM = 200   # Pixels from bottom
IGNORE_LEFT = 60      # Pixels from left
IGNORE_RIGHT = 60     # Pixels from right
```

### Name Detection Parameters
```python
MIN_NAME_WIDTH = 25
MAX_NAME_WIDTH = 300
MIN_NAME_HEIGHT = 8
MAX_NAME_HEIGHT = 35
MIN_ASPECT_RATIO = 1.5
MAX_ASPECT_RATIO = 20
```

### Combat Settings
```python
MIN_HEALTH_THRESHOLD = 5      # Attack if health > 5%
MAX_TARGETS_PER_CYCLE = 2     # Max clicks per cycle
CYCLE_DELAY = 0.4             # Seconds between cycles
NAMEPLATE_TIMEOUT = 1.0       # Nameplate wait time
CLICK_DELAY = 0.25            # Delay after clicking
```

### Priority System
```python
CLASS_PRIORITIES = {
    'Unique': 1,      # Highest priority
    'Champion': 2,
    'Giant': 3,
    'General': 4,
    'Elite': 5        # Lowest priority
}
```

### Skill Rotation
```python
SKILL_KEYS = ['1', '2', '3', '4']
SKILL_DELAY = 0.6  # Seconds between skills
```

### Blacklist
```python
KNOWN_PETS = ['Gom3a', 'Savy', 'gom3a', 'savy']
PLAYER_INDICATORS = ['SnowRunner', 'snowrunner', '[', ']', '<', '>', 'Moon', 'Trade']
KNOWN_MOBS = ['Mangyang', 'mangyang', 'Ghost', 'ghost', 'Wolf', 'Bear', 'Small', 'eyed']
```

---

## üéØ KEY DIFFERENCES FROM PREVIOUS VERSIONS

### v3.0 vs v2.0
1. **No EasyOCR/Tesseract:** Uses simple pattern matching instead
2. **MSS Screen Capture:** Instead of win32gui.PrintWindow
3. **Color-Based Class Detection:** Instead of OCR text recognition
4. **OpenCV Overlay:** Instead of Tkinter
5. **Simpler Architecture:** More modular, easier to understand
6. **Session Logging:** Timestamped directories with screenshots
7. **Position Caching:** Prevents duplicate clicks
8. **Player Zone Filtering:** Skips center screen area

---

## üîß TECHNICAL DETAILS

### Screen Capture
- **Library:** `mss` (fast screen capture)
- **Method:** `mss.grab()` with full screen region
- **Format:** BGRA ‚Üí BGR conversion for OpenCV

### Image Processing
- **Grayscale conversion:** `cv2.cvtColor(BGR2GRAY)`
- **Thresholding:** Multiple thresholds [200, 180, 160]
- **Morphological operations:** Closing with horizontal kernel
- **Contour detection:** `cv2.findContours()` with `RETR_EXTERNAL`
- **Edge detection:** Canny edge detector for text validation

### Color Detection
- **HSV Color Space:** Used for class and health detection
- **Yellow Range:** [20-30¬∞] for Elite detection
- **Red Ranges:** [0-10¬∞] and [170-180¬∞] for health bar (red wraps around)
- **Color Masking:** `cv2.inRange()` for color filtering

### Position Management
- **Grid-based caching:** 35px proximity threshold
- **Time-based expiration:** 2.5 second cache duration
- **Automatic cleanup:** Removes expired entries

---

## üìù TASK HISTORY

### 2024-12-19 - Added CapsLock Start/Pause and Ctrl+C Shutdown
- ‚úÖ Added `pynput` import for keyboard listener
- ‚úÖ Added `signal` import for Ctrl+C handling
- ‚úÖ Added `is_paused` flag to MobHunter class (starts paused)
- ‚úÖ Added `should_exit` flag for graceful shutdown
- ‚úÖ Added `setup_keyboard_listener()` method for CapsLock toggle
- ‚úÖ Added `shutdown()` method for graceful cleanup
- ‚úÖ Updated `run()` method to check paused state
- ‚úÖ Updated `run_cycle()` to skip when paused
- ‚úÖ Added signal handler for Ctrl+C in `main()`
- ‚úÖ Updated startup message to show new controls
- ‚úÖ Bot now starts paused, waits for CapsLock to begin

### 2024-12-19 - Initial Memory File Creation
- ‚úÖ Reviewed complete application code
- ‚úÖ Documented all classes and methods
- ‚úÖ Documented configuration parameters
- ‚úÖ Documented detection pipeline
- ‚úÖ Documented logging system
- ‚úÖ Documented key differences from previous versions
- ‚úÖ Created comprehensive memory file

---

## üêõ KNOWN ISSUES & LIMITATIONS

### Current Limitations
1. **No Actual OCR:** Uses pattern matching, not text recognition
2. **Hardcoded Regions:** Nameplate region is fixed (may need adjustment)
3. **Simple Filtering:** Player/pet detection is heuristic-based
4. **No Health Monitoring:** Doesn't track health during combat
5. **Fixed Skill Rotation:** No dynamic skill selection
6. **Screen Resolution:** Hardcoded to 1920x1080

### Potential Improvements
- [ ] Add actual OCR for name recognition
- [ ] Dynamic nameplate region detection
- [ ] Health monitoring during combat
- [ ] Adaptive skill rotation
- [ ] Multi-resolution support
- [ ] Better pet/player detection
- [ ] Loot detection and pickup

---

## üîç DEBUGGING

### Debug Mode
- `Config.DEBUG_MODE = True` enables detailed logging
- `Config.SAVE_SCREENSHOTS = True` saves screenshots every 10 cycles

### Log Files
- Check `logs/session_*/bot.log` for detailed execution logs
- Check `logs/session_*/screenshots/` for captured frames

### Overlay
- Press any key in overlay window to close
- Overlay shows real-time detections and statistics

---

## üì¶ DEPENDENCIES

### Core Libraries
- `mss>=9.0.0` - Screen capture
- `opencv-python>=4.8.0` - Image processing
- `numpy>=1.24.0` - Array operations
- `pyautogui>=0.9.54` - Mouse/keyboard automation
- `Pillow>=10.0.0` - Image handling

### Required for Keyboard Controls
- `pynput>=1.7.6` - **NOW USED** for CapsLock start/pause functionality

### Optional (in requirements but not used)
- `pytesseract>=0.3.10` - Not used (simple OCR instead)
- `pywin32>=306` - Not used
- `psutil>=5.9.0` - Not used

---

## üéÆ USAGE

### Starting the Bot
```bash
python mob_hunter.py
```

### Controls
- **CapsLock:** Toggle START/PAUSE (bot starts paused)
- **Ctrl+C:** Stop bot gracefully and exit
- **Overlay Window:** Press any key to close

### Output
- Console: Real-time status messages
- Log File: Detailed execution log in `logs/session_*/bot.log`
- Screenshots: Saved every 10 cycles in `logs/session_*/screenshots/`

---

## üìä STATISTICS TRACKED

### Per Session
- Total cycles
- Total clicks
- Total engagements/kills
- Cache hit rate
- Uptime
- Average cycle time

### Per Cycle
- Number of detections
- Number of valid targets
- Number of confirmed mobs
- Cache size

---

## ‚ö†Ô∏è IMPORTANT NOTES

1. **Screen Resolution:** Currently hardcoded to 1920x1080
2. **Nameplate Region:** Fixed at (660, 10, 600, 100) - may need adjustment
3. **Health Bar Width:** Assumes 300px full width for percentage calculation
4. **Player Zone:** Center ¬±200px x, center ¬±100-150px y
5. **No Game Window Detection:** Captures full screen (not game window specific)
6. **PyAutoGUI Failsafe:** Disabled (`FAILSAFE = False`)
7. **Threading:** Overlay runs in daemon thread

---

## üîÑ UPDATE LOG

### 2024-12-19 - Added Keyboard Controls
- Added CapsLock start/pause functionality
- Added Ctrl+C graceful shutdown
- Bot now starts in paused state
- Updated memory file with new controls

### 2024-12-19 - Memory File Creation
- Created comprehensive memory file
- Documented all classes, methods, and configuration
- Documented detection pipeline and architecture
- Documented logging system and statistics
- Documented key differences from previous versions
- Documented known limitations and potential improvements

---

**END OF MEMORY FILE**

*This file will be updated after each task to track changes and improvements.*
